name: CMS Deploy

on:
  repository_dispatch:
    types: [cms-content-updated]
  workflow_dispatch:
    inputs:
      site:
        description: 'Site to deploy'
        required: false
        default: 'both'
        type: choice
        options:
          - both
          - molly
          - micah

jobs:
  determine-sites:
    runs-on: ubuntu-latest
    outputs:
      deploy-molly: ${{ steps.sites.outputs.deploy-molly }}
      deploy-micah: ${{ steps.sites.outputs.deploy-micah }}
    steps:
      - name: Determine sites to deploy
        id: sites
        run: |
          # Check if this was triggered by repository_dispatch
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            # Use the event_type (github.event.action) to determine which site to deploy
            SITE_FILTER="${{ github.event.action }}"
            echo "Repository dispatch with event type: $SITE_FILTER"
          else
            # Manual workflow dispatch
            SITE_FILTER="${{ github.event.inputs.site || 'both' }}"
            echo "Manual dispatch with site: $SITE_FILTER"
          fi
          
          case $SITE_FILTER in
            "molly"|"mollyferguson"|"mollyferguson.info")
              echo 'deploy-molly=true' >> $GITHUB_OUTPUT
              echo 'deploy-micah=false' >> $GITHUB_OUTPUT
              echo "Deploying: mollyferguson.info only"
              ;;
            "micah"|"micah-ferguson")
              echo 'deploy-molly=false' >> $GITHUB_OUTPUT
              echo 'deploy-micah=true' >> $GITHUB_OUTPUT
              echo "Deploying: micah-ferguson only"
              ;;
            *)
              echo 'deploy-molly=true' >> $GITHUB_OUTPUT
              echo 'deploy-micah=true' >> $GITHUB_OUTPUT
              echo "Deploying: both sites"
              ;;
          esac

  deploy-molly:
    needs: determine-sites
    if: needs.determine-sites.outputs.deploy-molly == 'true'
    runs-on: ubuntu-latest
    environment: production
    
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      NPM_GH_TOKEN: ${{ secrets.NPM_GH_TOKEN }}
      ASTRO_HYGRAPH_ENDPOINT: https://us-east-1-shared-usea1-02.cdn.hygraph.com/content/cm048oo3l01gz07wf7rrq84lg/master

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version-file: '.nvmrc'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build mollyferguson.info
      run: npm run build:molly

    - name: Deploy mollyferguson.info
      run: npm run deploy:molly

    - name: Report deployment status
      run: |
        echo "ðŸš€ Deployment of mollyferguson.info completed successfully!"
        echo "Triggered by: ${{ github.event_name }}"

  deploy-micah:
    needs: determine-sites
    if: needs.determine-sites.outputs.deploy-micah == 'true'
    runs-on: ubuntu-latest
    environment: production
    
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      NPM_GH_TOKEN: ${{ secrets.NPM_GH_TOKEN }}
      ASTRO_HYGRAPH_ENDPOINT: https://us-west-2.cdn.hygraph.com/content/cm4ah46tx01ol07lnfafy43gg/master

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version-file: '.nvmrc'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build micah-ferguson
      run: npm run build:micah

    - name: Deploy micah-ferguson
      run: npm run deploy:micah

    - name: Report deployment status
      run: |
        echo "ðŸš€ Deployment of micah-ferguson completed successfully!"
        echo "Triggered by: ${{ github.event_name }}" 